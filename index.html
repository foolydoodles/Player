<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reddit Video Browser</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
    <style>
        html, body {
            height: 100%;
            overflow: hidden; /* Prevent body scroll */
        }
        body {
            font-family: 'DM Mono', monospace;
        }
        /* Custom styles to match the new theme */
        .subreddit-item:hover, .video-list-item:hover {
            background-color: #374151; /* gray-700 */
        }
        .subreddit-item.selected {
            background-color: #4338ca; /* indigo-700 */
            color: white;
        }
        .video-list-item.selected {
            background-color: #312e81; /* indigo-800 */
        }
        /* Scrollbar styling for a consistent look */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #1f2937; /* gray-800 */
        }
        ::-webkit-scrollbar-thumb {
            background: #111827; /* gray-900 */
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #1f2937; /* gray-800 */
        }
    </style>
     <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=DM+Mono:wght@400;500&display=swap" rel="stylesheet">
</head>
<body class="bg-[#2f3136] text-gray-300">

    <div class="flex h-screen">
        <!-- Left Column: Controls -->
        <div class="flex flex-col w-72 bg-[#202225] p-3">
            <header class="mb-4 px-2">
                <h1 class="text-lg font-bold text-white">Video Browser</h1>
            </header>
            
            <div class="flex-grow flex flex-col min-h-0">
                <label class="block text-xs font-semibold text-gray-400 mb-2 px-2 uppercase tracking-wider">Subreddits</label>
                <ul id="subreddit-list" class="flex-grow space-y-1 pr-1 overflow-y-auto"></ul>

                <div class="mt-4 space-y-2">
                    <div class="flex gap-2">
                        <input type="text" id="subreddit-input" placeholder="Add subreddit..." class="flex-grow w-full px-3 py-2 bg-[#2f3136] border border-gray-900 rounded-md focus:ring-indigo-500 focus:border-indigo-500 transition text-sm text-white">
                        <button id="add-subreddit-btn" class="px-3 py-2 bg-indigo-600 text-white font-semibold rounded-md hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-offset-gray-900 focus:ring-indigo-500 transition-colors text-sm">Add</button>
                    </div>
                    <button id="remove-subreddit-btn" class="w-full px-3 py-2 bg-gray-700 text-gray-300 font-semibold rounded-md hover:bg-gray-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-offset-gray-900 focus:ring-gray-500 transition-colors text-sm">Remove Selected</button>
                </div>
            </div>
             <button id="fetch-btn" class="w-full mt-4 px-4 py-3 bg-green-600 text-white font-bold rounded-lg hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-offset-gray-900 focus:ring-green-500 transition-colors flex items-center justify-center gap-2">
                <svg id="fetch-icon" xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h5M20 20v-5h-5M4 20h5v-5M20 4h-5v5" />
                </svg>
                <span id="fetch-btn-text">Fetch Videos</span>
                <div id="loading-spinner" class="hidden animate-spin rounded-full h-5 w-5 border-b-2 border-white"></div>
            </button>
        </div>

        <!-- Right Column: Video Viewer -->
        <div class="flex-1 flex flex-col bg-[#2f3136]">
             <header class="flex-shrink-0 bg-[#2f3136] shadow-md z-10 p-4 border-b border-black/30">
                 <p id="status-label" class="text-sm text-gray-400">Add subreddits and click 'Fetch' to begin.</p>
             </header>
             <div class="flex-grow flex min-h-0">
                <!-- Video List -->
                <div id="video-list-container" class="w-1/3 flex flex-col bg-[#2f3136] border-r border-black/30">
                    <div id="video-list" class="p-2 space-y-1 overflow-y-auto flex-grow">
                       <p class="p-4 text-center text-gray-500 text-sm">No videos fetched yet.</p>
                    </div>
                </div>
                <!-- Video Player Viewer -->
                <div class="w-2/3 flex flex-col p-4">
                    <div class="flex-grow border border-black/30 rounded-lg overflow-hidden bg-black relative">
                        <video id="video-player" src="" class="absolute inset-0 w-full h-full object-contain" controls autoplay loop>
                            Your browser does not support the video tag.
                        </video>
                         <div id="video-placeholder" class="absolute inset-0 flex flex-col items-center justify-center text-center text-gray-500">
                             <p>Select a video from the list to play it here.</p>
                         </div>
                    </div>
                     <button id="download-btn" disabled class="mt-4 w-full px-4 py-3 bg-indigo-600 text-white font-bold text-lg rounded-lg hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-offset-gray-900 focus:ring-indigo-500 transition-colors disabled:bg-gray-600 disabled:cursor-not-allowed flex items-center justify-center gap-2">
                         <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" /></svg>
                         Download Video (with sound)
                     </button>
                </div>
             </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- DOM Elements ---
            const subredditListEl = document.getElementById('subreddit-list');
            const subredditInput = document.getElementById('subreddit-input');
            const addBtn = document.getElementById('add-subreddit-btn');
            const removeBtn = document.getElementById('remove-subreddit-btn');
            const fetchBtn = document.getElementById('fetch-btn');
            const fetchBtnText = document.getElementById('fetch-btn-text');
            const fetchIcon = document.getElementById('fetch-icon');
            const loadingSpinner = document.getElementById('loading-spinner');
            const videoListEl = document.getElementById('video-list');
            const statusLabel = document.getElementById('status-label');
            const videoPlayer = document.getElementById('video-player');
            const videoPlaceholder = document.getElementById('video-placeholder');
            const downloadBtn = document.getElementById('download-btn');

            // --- App State ---
            let subreddits = ['MadeMeSmile', 'nextfuckinglevel'];
            let videoData = [];
            let selectedSubreddit = null;
            let currentVideo = null;

            // --- Functions ---
            function timeAgo(timestamp) {
                const now = new Date();
                const secondsPast = (now.getTime() - timestamp * 1000) / 1000;

                if (secondsPast < 60) return `${Math.round(secondsPast)}s ago`;
                if (secondsPast < 3600) return `${Math.round(secondsPast / 60)}m ago`;
                if (secondsPast <= 86400) return `${Math.round(secondsPast / 3600)}h ago`;
                if (secondsPast > 86400) {
                    const days = Math.round(secondsPast / 86400);
                    return `${days}d ago`;
                }
            }

            function renderSubredditList() {
                subredditListEl.innerHTML = '';
                if (subreddits.length === 0) {
                    const li = document.createElement('li');
                    li.textContent = "No subreddits added.";
                    li.className = 'text-gray-500 italic text-center p-2 text-sm';
                    subredditListEl.appendChild(li);
                } else {
                    subreddits.forEach(sub => {
                        const li = document.createElement('li');
                        li.className = 'p-2 rounded-md cursor-pointer hover:bg-[#3a3d42] transition-colors subreddit-item flex items-center gap-2';
                        li.dataset.name = sub;
                        li.innerHTML = `<span class="text-gray-500 font-bold text-lg">#</span><span class="text-gray-300 font-medium">${sub}</span>`;
                        if (sub === selectedSubreddit) li.classList.add('selected');
                        subredditListEl.appendChild(li);
                    });
                }
            }

            function renderVideoList(filterSubreddit = null) {
                videoListEl.innerHTML = '';
                const videosToRender = filterSubreddit ? videoData.filter(video => video.subreddit === filterSubreddit) : videoData;

                if (videosToRender.length === 0) {
                    videoListEl.innerHTML = `<p class="p-4 text-center text-gray-500 text-sm">No videos found${filterSubreddit ? ` in r/${filterSubreddit}` : ''}.</p>`;
                    return;
                }
                videosToRender.forEach((video, index) => {
                    const div = document.createElement('div');
                    div.className = 'video-list-item p-3 rounded-lg cursor-pointer border-l-4 border-transparent';
                    div.innerHTML = `<p class="font-semibold text-gray-200 leading-tight">${video.title}</p><div class="flex justify-between items-center mt-1"><p class="text-xs text-gray-400">r/${video.subreddit}</p><p class="text-xs text-gray-500">${timeAgo(video.created_utc)}</p></div>`;
                    div.addEventListener('click', () => handleVideoSelection(video, div));
                    videoListEl.appendChild(div);
                });
            }

            function addSubreddit() {
                let subName = subredditInput.value.trim();
                if (subName) {
                    if (subName.toLowerCase().startsWith('r/')) subName = subName.substring(2);
                    if (!subreddits.includes(subName)) {
                        subreddits.push(subName);
                        subredditInput.value = '';
                        renderSubredditList();
                    } else {
                        alert(`'${subName}' is already in the list.`);
                    }
                }
            }

            function removeSubreddit() {
                if (selectedSubreddit) {
                    subreddits = subreddits.filter(sub => sub !== selectedSubreddit);
                    selectedSubreddit = null;
                    renderSubredditList();
                    renderVideoList();
                } else {
                    alert('Please select a subreddit to remove.');
                }
            }
            
            function setUiLoading(isLoading) {
                fetchBtn.disabled = isLoading;
                fetchBtnText.textContent = isLoading ? 'Fetching...' : 'Fetch Videos';
                fetchIcon.classList.toggle('hidden', isLoading);
                loadingSpinner.classList.toggle('hidden', !isLoading);
                statusLabel.textContent = isLoading ? "Fetching videos from Reddit..." : "Ready.";
            }
            
            async function fetchVideos() {
                if (subreddits.length === 0) {
                    alert("Please add at least one subreddit.");
                    return;
                }
                setUiLoading(true);
                videoListEl.innerHTML = '<p class="p-4 text-center text-gray-400 text-sm">Fetching...</p>';

                const fetchPromises = subreddits.map(sub => {
                    const url = `https://www.reddit.com/r/${sub}/hot.json?limit=100`;
                    return fetch(url).then(res => {
                        if (!res.ok) throw new Error(`Failed to fetch r/${sub}`);
                        return res.json();
                    }).catch(err => {
                        console.error(err);
                        return null;
                    });
                });

                const results = await Promise.all(fetchPromises);
                
                const allPosts = results.flatMap(result => result ? result.data.children : []);
                const seenPermalinks = new Set();
                
                videoData = [];
                allPosts.forEach(post => {
                    const permalink = `https://www.reddit.com${post.data.permalink}`;
                    const fallbackUrl = post.data?.media?.reddit_video?.fallback_url;
                    const hlsUrl = post.data?.media?.reddit_video?.hls_url;
                    
                    if (post.data.is_video && fallbackUrl && !seenPermalinks.has(permalink)) {
                        seenPermalinks.add(permalink);
                        videoData.push({
                            title: post.data.title,
                            subreddit: post.data.subreddit,
                            permalink: permalink,
                            video_url: fallbackUrl.replace('?source=fallback', ''),
                            hls_url: hlsUrl, // Store the HLS URL which contains audio
                            created_utc: post.data.created_utc
                        });
                    }
                });
                
                videoData.sort((a, b) => b.created_utc - a.created_utc);

                renderVideoList();
                setUiLoading(false);
                statusLabel.textContent = `Found ${videoData.length} videos. Click a video to view it.`;
                videoPlayer.classList.add('hidden');
                videoPlaceholder.classList.remove('hidden');
                downloadBtn.disabled = true;
                selectedSubreddit = null;
                renderSubredditList();
            }

            function handleVideoSelection(video, element) {
                document.querySelectorAll('.video-list-item.selected').forEach(el => el.classList.remove('selected'));
                element.classList.add('selected');
                
                currentVideo = video;
                videoPlaceholder.classList.add('hidden');
                videoPlayer.classList.remove('hidden');
                
                // Destroy any existing HLS instance to prevent memory leaks
                if (window.currentHls) {
                    window.currentHls.destroy();
                }

                if (video.hls_url && Hls.isSupported()) {
                    // If HLS is supported and a URL exists, use it to play video with sound
                    console.log("HLS supported. Playing with audio.");
                    const hls = new Hls();
                    hls.loadSource(video.hls_url);
                    hls.attachMedia(videoPlayer);
                    hls.on(Hls.Events.MANIFEST_PARSED, function() {
                        videoPlayer.play().catch(e => {
                            console.error("Autoplay with sound was prevented:", e);
                            statusLabel.textContent = `Viewing: ${video.title} (Click video to play)`;
                        });
                    });
                    window.currentHls = hls; // Store instance for later destruction
                } else {
                    // Fallback to the video-only URL
                    console.log("HLS not supported or no HLS URL. Playing without audio.");
                    videoPlayer.src = video.video_url;
                    videoPlayer.load();
                    videoPlayer.play();
                }
                
                downloadBtn.disabled = false;
                statusLabel.textContent = `Viewing: ${video.title}`;
            }
            
            function handleDownload() {
                if (currentVideo) {
                    const downloadUrl = `https://viddit.io/download?url=${currentVideo.permalink}`;
                    window.open(downloadUrl, '_blank');
                    statusLabel.textContent = `✅ Opened download page for: ${currentVideo.title}`;
                }
            }

            // --- Event Listeners ---
            addBtn.addEventListener('click', addSubreddit);
            subredditInput.addEventListener('keypress', e => e.key === 'Enter' && addSubreddit());
            removeBtn.addEventListener('click', removeSubreddit);
            fetchBtn.addEventListener('click', fetchVideos);
            downloadBtn.addEventListener('click', handleDownload);

            subredditListEl.addEventListener('click', e => {
                const li = e.target.closest('li.subreddit-item');
                if (li) {
                    selectedSubreddit = li.dataset.name;
                    renderSubredditList();
                    renderVideoList(selectedSubreddit);
                }
            });

            // --- Initial Render ---
            videoPlayer.classList.add('hidden');
            renderSubredditList();
        });
    </script>
</body>
</html>
